name: Generate Collection Config

on:
  issues:
    types: [labeled]

permissions:
  contents: write

jobs:
  create-branch:
    if: github.event.label.name == 'collection-request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Parse slug from issue body
        id: parse
        run: |
          SLUG=$(echo "${{ github.event.issue.body }}" | awk '
            BEGIN { found=0 }
            /^\s*### Collection Slug/ { found=1; next }
            /^\s*### / { found=0 }
            found && NF { print; exit }
          ' | xargs)

          echo "slug=$SLUG" >> $GITHUB_OUTPUT

      - name: Check if branch already exists
        run: |
          BRANCH="collection/${{ steps.parse.outputs.slug }}"
          if git ls-remote --exit-code --heads origin "$BRANCH"; then
            echo "Branch already exists. Exiting."
            exit 0
          fi

      - name: Create and push branch with bot credentials
        env:
          BOT_PAT: ${{ secrets.BOT_PAT }}
          REPO: ${{ github.repository }}
        run: |
          BRANCH="collection/${{ steps.parse.outputs.slug }}"
          mkdir -p collections/${{ steps.parse.outputs.slug }}
          cp template/collection/*.toml collections/${{ steps.parse.outputs.slug }}/

          git config user.name "hodlcroft-bot"
          git config user.email "bot@hodlcroft.com"

          git checkout -b "$BRANCH"
          git add .
          git commit -m "Initialize collection '${{ steps.parse.outputs.slug }}'"

          # Use PAT to authenticate the push
          git push https://x-access-token:$BOT_PAT@github.com/$REPO.git "$BRANCH"
