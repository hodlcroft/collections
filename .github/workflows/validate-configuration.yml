name: Validate TOML Files

on:
  pull_request:
    paths:
      - "**/*.toml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            tools/validator/target
          key: rust-validate-${{ runner.os }}-${{ hashFiles('tools/validator/Cargo.lock', 'tools/validator/src/**/*.rs') }}
          restore-keys: |
            rust-validate-${{ runner.os }}-

      - name: Build validator (only if needed)
        working-directory: tools/validator
        run: |
          if [ -f target/release/validator ]; then
            echo "âœ… Validator already built from cache"
          else
            echo "ðŸ”¨ Building validator..."
            cargo build --release
          fi

      - name: Get changed TOML files via GitHub API
        id: get_files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(jq .pull_request.number "$GITHUB_EVENT_PATH")
          FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' | grep '\.toml$' || true)
          echo "files=${FILES//$'\n'/,}" >> "$GITHUB_OUTPUT"

      - name: Run validator
        if: steps.get_files.outputs.files != ''
        run: |
          IFS=',' read -ra FILES <<< "${{ steps.get_files.outputs.files }}"
          ./tools/validator/target/release/validator "${FILES[@]}"
